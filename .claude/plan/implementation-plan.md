# YouTube åŒè¯­å­—å¹•ä»£ç† - å®æ–½è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**ï¼šæ„å»º YouTube å­—å¹•ä»£ç†æœåŠ¡ï¼Œè§£å†³æ‰‹æœºç«¯å¤§æ¨¡å‹ç¿»è¯‘è¶…æ—¶é—®é¢˜

**æ ¸å¿ƒä»·å€¼**ï¼š
- é¦–æ¬¡è¯·æ±‚å¿«é€Ÿè¿”å›åŸå­—å¹•ï¼ˆ< 2sï¼Œä¸é˜»å¡æ’­æ”¾ï¼‰
- åå°å¼‚æ­¥ç¿»è¯‘ï¼ˆOpenAI GPT-4oï¼‰
- äºŒæ¬¡è¯·æ±‚è¿”å›åŒè¯­å­—å¹•ï¼ˆæ®µè½çº§ï¼ŒåŒè¡Œæ˜¾ç¤ºï¼‰
- æŒä¹…åŒ–ç¼“å­˜ï¼ˆ30 å¤© TTLï¼‰

**æŠ€æœ¯æ ˆ**ï¼š
- è¿è¡Œæ—¶ï¼šNode.js 20+ / Deno
- æ¡†æ¶ï¼šHonoï¼ˆè½»é‡ã€è¾¹ç¼˜å‹å¥½ï¼‰
- æ•°æ®åº“ï¼šSQLiteï¼ˆé›¶é…ç½®ï¼‰
- ç¿»è¯‘ï¼šOpenAI GPT-4o API
- éƒ¨ç½²ï¼šè‡ªå»º VPS + Docker

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  iOS è®¾å¤‡ï¼ˆLoon/åœˆXï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ‹¦æˆª YouTube å­—å¹•è¯·æ±‚                 â”‚   â”‚
â”‚  â”‚ *.googlevideo.com/api/timedtext      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼ é‡å†™ä¸ºä»£ç† URL                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»£ç†æœåŠ¡å™¨ï¼ˆHono + SQLiteï¼‰                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. æ£€æŸ¥ç¼“å­˜ï¼ˆvideo_id + langï¼‰        â”‚   â”‚
â”‚  â”‚    â”œâ”€ ç¼“å­˜å‘½ä¸­ â†’ è¿”å›åŒè¯­å­—å¹•          â”‚   â”‚
â”‚  â”‚    â””â”€ ç¼“å­˜æœªå‘½ä¸­ â†’ ç»§ç»­                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. è·å–åŸå§‹å­—å¹•ï¼ˆYouTube APIï¼‰        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. ç«‹å³è¿”å›åŸå­—å¹•ï¼ˆæ»¡è¶³è¶…æ—¶è¦æ±‚ï¼‰      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”ƒ åå°å¼‚æ­¥                      â”‚
â”‚               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. æ®µè½åˆ‡åˆ†ï¼ˆ3-7 ç§’ä¸€æ®µï¼‰             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 5. è°ƒç”¨ GPT-4o ç¿»è¯‘ï¼ˆå¹¶å‘ 2ï¼‰         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 6. åˆå¹¶åŒè¯­å­—å¹•ï¼ˆåŸæ–‡\nè¯‘æ–‡ï¼‰          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 7. å†™å…¥ SQLite ç¼“å­˜                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
youtube-subtitle-proxy/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ env.ts                  # ç¯å¢ƒå˜é‡é…ç½®
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ schema.sql              # SQLite è¡¨ç»“æ„
â”‚   â”‚   â””â”€â”€ sqlite.ts               # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ http/
â”‚   â”‚   â”œâ”€â”€ server.ts               # Hono æœåŠ¡å™¨å…¥å£
â”‚   â”‚   â””â”€â”€ routes.ts               # API è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â””â”€â”€ queue.ts                # è¿›ç¨‹å†…ä»»åŠ¡é˜Ÿåˆ—
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ youtube.ts              # YouTube API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ translator.ts           # OpenAI ç¿»è¯‘æœåŠ¡
â”‚   â”‚   â””â”€â”€ cache.ts                # ç¼“å­˜ç®¡ç†ï¼ˆLRU + SQLiteï¼‰
â”‚   â”œâ”€â”€ subtitle/
â”‚   â”‚   â”œâ”€â”€ parse.ts                # å­—å¹•è§£æ
â”‚   â”‚   â”œâ”€â”€ segment.ts              # æ®µè½åˆ‡åˆ†ç®—æ³•
â”‚   â”‚   â””â”€â”€ render.ts               # WebVTT æ¸²æŸ“
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ subtitle.ts             # ç±»å‹å®šä¹‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ loon/
â”‚   â”‚   â””â”€â”€ youtube-subtitle.js     # Loon è„šæœ¬
â”‚   â””â”€â”€ quantumultx/
â”‚       â””â”€â”€ youtube-subtitle.js     # åœˆX è„šæœ¬
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ backend-architecture.md     # åç«¯æ¶æ„æ–‡æ¡£ï¼ˆCodex è¾“å‡ºï¼‰
â”‚   â””â”€â”€ frontend-config.md          # å‰ç«¯é…ç½®æ–‡æ¡£ï¼ˆClaude è¾“å‡ºï¼‰
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â””â”€â”€ integration/
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### caption_jobs è¡¨ï¼ˆä»»åŠ¡è·Ÿè¸ªï¼‰

```sql
CREATE TABLE IF NOT EXISTS caption_jobs (
  id TEXT PRIMARY KEY,                    -- UUID
  video_id TEXT NOT NULL,                 -- YouTube è§†é¢‘ ID
  lang TEXT NOT NULL,                     -- åŸå­—å¹•è¯­è¨€ï¼ˆen, ja, koï¼‰
  track TEXT NOT NULL,                    -- å­—å¹•è½¨é“åç§°
  fmt TEXT NOT NULL,                      -- æ ¼å¼ï¼ˆvtt, srv3ï¼‰
  source_hash TEXT NOT NULL,              -- åŸå­—å¹• SHA256ï¼ˆæ£€æµ‹å˜æ›´ï¼‰
  status TEXT NOT NULL,                   -- pending|translating|done|failed
  retry_count INTEGER DEFAULT 0,          -- é‡è¯•æ¬¡æ•°
  next_retry_at INTEGER,                  -- ä¸‹æ¬¡é‡è¯•æ—¶é—´æˆ³
  error_code TEXT,                        -- é”™è¯¯ä»£ç 
  error_message TEXT,                     -- é”™è¯¯ä¿¡æ¯
  bilingual_json TEXT,                    -- åŒè¯­å­—å¹• JSONï¼ˆæœ€ç»ˆç»“æœï¼‰
  created_at INTEGER NOT NULL,            -- åˆ›å»ºæ—¶é—´
  updated_at INTEGER NOT NULL,            -- æ›´æ–°æ—¶é—´
  expires_at INTEGER NOT NULL,            -- è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰

  UNIQUE(video_id, lang, track, fmt, source_hash)
);

CREATE INDEX idx_jobs_status ON caption_jobs(status, next_retry_at);
CREATE INDEX idx_jobs_expires ON caption_jobs(expires_at);
```

### caption_segments è¡¨ï¼ˆæ®µè½ç¿»è¯‘ï¼‰

```sql
CREATE TABLE IF NOT EXISTS caption_segments (
  id TEXT PRIMARY KEY,
  job_id TEXT NOT NULL,
  segment_index INTEGER NOT NULL,
  start_ms INTEGER NOT NULL,              -- å¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  end_ms INTEGER NOT NULL,                -- ç»“æŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  source_text TEXT NOT NULL,              -- åŸæ–‡
  translated_text TEXT,                   -- è¯‘æ–‡
  status TEXT NOT NULL,                   -- pending|done|failed
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,

  FOREIGN KEY(job_id) REFERENCES caption_jobs(id),
  UNIQUE(job_id, segment_index)
);
```

---

## ğŸ”Œ API è®¾è®¡

### æ ¸å¿ƒç«¯ç‚¹

#### `GET /api/subtitle`

**åŠŸèƒ½**ï¼šä»£ç† YouTube å­—å¹•è¯·æ±‚

**æŸ¥è¯¢å‚æ•°**ï¼š

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `v` | string | âœ… | è§†é¢‘ ID |
| `lang` | string | âœ… | åŸå­—å¹•è¯­è¨€ |
| `tlang` | string | âœ… | ç›®æ ‡ç¿»è¯‘è¯­è¨€ï¼ˆé»˜è®¤ zh-CNï¼‰ |
| `fmt` | string | âŒ | æ ¼å¼ï¼ˆvtt/srv3ï¼Œé»˜è®¤ vttï¼‰ |
| `original_url` | string | âŒ | YouTube åŸå§‹ URLï¼ˆç”¨äºå›æºï¼‰ |

**å“åº”**ï¼š

**é¦–æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰**ï¼š
```http
HTTP/1.1 200 OK
Content-Type: text/vtt; charset=utf-8
X-Translation-Status: pending
X-Estimated-Time: 45
X-Cache-Status: MISS

WEBVTT
[åŸå­—å¹•å†…å®¹]
```

**äºŒæ¬¡è¯·æ±‚ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰**ï¼š
```http
HTTP/1.1 200 OK
Content-Type: text/vtt; charset=utf-8
X-Translation-Status: completed
X-Cache-Status: HIT

WEBVTT
1
00:00:01.000 --> 00:00:04.500
Original text here
åŸæ–‡ç¿»è¯‘åœ¨è¿™é‡Œ
```

---

## ğŸ§© æ ¸å¿ƒç®—æ³•

### 1. æ®µè½åˆ‡åˆ†ç®—æ³•

**ç›®æ ‡**ï¼šå°†é€è¯å­—å¹•åˆå¹¶ä¸º 3-7 ç§’çš„æ®µè½

```typescript
interface SubtitleCue {
  startTime: number;  // æ¯«ç§’
  endTime: number;
  text: string;
}

function mergeSubtitleCues(
  rawCues: SubtitleCue[],
  minDuration = 3000,  // 3 ç§’
  maxDuration = 7000   // 7 ç§’
): SubtitleCue[] {
  const merged: SubtitleCue[] = [];
  let currentGroup: string[] = [];
  let groupStartTime: number | null = null;
  let groupEndTime: number | null = null;

  for (const cue of rawCues) {
    if (!groupStartTime) {
      // æ–°æ®µè½å¼€å§‹
      groupStartTime = cue.startTime;
      groupEndTime = cue.endTime;
      currentGroup.push(cue.text);
    } else {
      const currentDuration = cue.endTime - groupStartTime;

      if (currentDuration <= maxDuration) {
        // ç»§ç»­è¿½åŠ åˆ°å½“å‰æ®µè½
        groupEndTime = cue.endTime;
        currentGroup.push(cue.text);
      } else {
        // å½“å‰æ®µè½ç»“æŸ
        if (groupEndTime! - groupStartTime >= minDuration) {
          merged.push({
            startTime: groupStartTime,
            endTime: groupEndTime!,
            text: currentGroup.join(' ')
          });
        }

        // å¼€å§‹æ–°æ®µè½
        groupStartTime = cue.startTime;
        groupEndTime = cue.endTime;
        currentGroup = [cue.text];
      }
    }
  }

  // å¤„ç†æœ€åä¸€ä¸ªæ®µè½
  if (currentGroup.length > 0 && groupStartTime && groupEndTime) {
    merged.push({
      startTime: groupStartTime,
      endTime: groupEndTime,
      text: currentGroup.join(' ')
    });
  }

  return merged;
}
```

---

### 2. ç¿»è¯‘æœåŠ¡

```typescript
import OpenAI from 'openai';

class TranslationService {
  private client: OpenAI;

  constructor(apiKey: string) {
    this.client = new OpenAI({ apiKey });
  }

  async translateSegment(
    text: string,
    targetLang: string = 'zh-CN'
  ): Promise<string> {
    const prompt = `Translate the following text to ${targetLang}. Return only the translation without any explanation.

Text: ${text}`;

    const response = await this.client.chat.completions.create({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.3,
      max_tokens: 500,
      timeout: 20000  // 20 ç§’è¶…æ—¶
    });

    return response.choices[0].message.content?.trim() || text;
  }

  async translateBatch(
    segments: SubtitleCue[],
    targetLang: string = 'zh-CN',
    concurrency: number = 2
  ): Promise<SubtitleCue[]> {
    const results: SubtitleCue[] = [];

    // å¹¶å‘æ§åˆ¶
    for (let i = 0; i < segments.length; i += concurrency) {
      const batch = segments.slice(i, i + concurrency);
      const promises = batch.map(segment =>
        this.translateSegment(segment.text, targetLang)
      );

      const translations = await Promise.all(promises);

      translations.forEach((translation, idx) => {
        results.push({
          ...batch[idx],
          text: `${batch[idx].text}\n${translation}`  // åŒè¯­æ ¼å¼
        });
      });
    }

    return results;
  }
}
```

---

### 3. WebVTT æ¸²æŸ“

```typescript
function renderWebVTT(segments: SubtitleCue[]): string {
  let vtt = 'WEBVTT\nKind: captions\nLanguage: zh-CN\n\n';
  vtt += 'NOTE\nGenerated by YouTube Subtitle Proxy\n\n';

  segments.forEach((segment, index) => {
    const startTime = formatTimestamp(segment.startTime);
    const endTime = formatTimestamp(segment.endTime);

    vtt += `${index + 1}\n`;
    vtt += `${startTime} --> ${endTime}\n`;
    vtt += `${segment.text}\n\n`;
  });

  return vtt;
}

function formatTimestamp(ms: number): string {
  const hours = Math.floor(ms / 3600000);
  const minutes = Math.floor((ms % 3600000) / 60000);
  const seconds = Math.floor((ms % 60000) / 1000);
  const milliseconds = ms % 1000;

  return `${pad(hours, 2)}:${pad(minutes, 2)}:${pad(seconds, 2)}.${pad(milliseconds, 3)}`;
}

function pad(num: number, length: number): string {
  return num.toString().padStart(length, '0');
}
```

---

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# OpenAI API
OPENAI_API_KEY=sk-proj-xxx
OPENAI_MODEL=gpt-4o
TRANSLATE_TIMEOUT_MS=20000
QUEUE_CONCURRENCY=2

# æ•°æ®åº“
DB_PATH=/data/subtitles.db
CACHE_TTL_HOURS=720  # 30 å¤©

# ç¼“å­˜ç­–ç•¥
LRU_MAX_ITEMS=1000
CLEANUP_INTERVAL_MS=3600000  # 1 å°æ—¶

# é‡è¯•ç­–ç•¥
MAX_RETRIES=3
RETRY_BASE_MS=5000

# YouTube API
YT_FETCH_TIMEOUT_MS=5000

# å­—å¹•å¤„ç†
SEGMENT_GAP_MS=1200
SEGMENT_MIN_DURATION_MS=3000
SEGMENT_MAX_DURATION_MS=7000

# å¯é€‰ï¼šç®¡ç†æ¥å£
ADMIN_TOKEN=your-secret-token
```

---

### Docker é…ç½®

#### Dockerfile

```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# æ„å»ºåº”ç”¨
COPY . .
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM node:20-alpine

WORKDIR /app

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package.json ./

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /data && chown nodejs:nodejs /data

USER nodejs

EXPOSE 3000

ENV NODE_ENV=production
ENV DB_PATH=/data/subtitles.db

CMD ["node", "dist/http/server.js"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  subtitle-proxy:
    build: .
    container_name: youtube-subtitle-proxy
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=gpt-4o
      - DB_PATH=/data/subtitles.db
      - CACHE_TTL_HOURS=720
      - LRU_MAX_ITEMS=1000
      - QUEUE_CONCURRENCY=2
    volumes:
      - subtitle-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  subtitle-data:
    driver: local
```

---

## ğŸ“± å‰ç«¯é…ç½®

### Loon è„šæœ¬å…³é”®ä»£ç 

```javascript
const CONFIG = {
  PROXY_BASE_URL: "https://your-domain.com",  // ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€
  TARGET_LANG: "zh-CN",
  ENABLE_NOTIFICATION: true,
  REQUEST_TIMEOUT: 10,
  DEBUG: false
};

function buildProxyUrl(originalUrl) {
  const url = new URL(originalUrl);
  const params = new URLSearchParams(url.search);

  const proxyUrl = new URL(`${CONFIG.PROXY_BASE_URL}/api/subtitle`);
  proxyUrl.searchParams.set('v', params.get('v'));
  proxyUrl.searchParams.set('lang', params.get('lang') || 'en');
  proxyUrl.searchParams.set('tlang', CONFIG.TARGET_LANG);
  proxyUrl.searchParams.set('fmt', params.get('fmt') || 'vtt');
  proxyUrl.searchParams.set('original_url', encodeURIComponent(originalUrl));

  return proxyUrl.toString();
}

function handleRequest() {
  const originalUrl = $request.url;
  const proxyUrl = buildProxyUrl(originalUrl);

  return {
    url: proxyUrl,
    headers: {
      ...($request.headers || {}),
      'X-Proxy-By': 'Loon-YouTube-Subtitle-Proxy'
    }
  };
}

$done(handleRequest());
```

å®Œæ•´è„šæœ¬è§ï¼š`scripts/loon/youtube-subtitle.js`

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

- âœ… æ®µè½åˆ‡åˆ†ç®—æ³•ï¼ˆä¸åŒæ—¶é•¿ã€è¾¹ç•Œæƒ…å†µï¼‰
- âœ… WebVTT æ¸²æŸ“ï¼ˆç‰¹æ®Šå­—ç¬¦ã€æ—¶é—´æˆ³æ ¼å¼ï¼‰
- âœ… ç¼“å­˜é”®ç”Ÿæˆï¼ˆä¸€è‡´æ€§ã€å“ˆå¸Œç®—æ³•ï¼‰
- âœ… é”™è¯¯å¤„ç†ï¼ˆè¶…æ—¶ã€API å¤±è´¥ï¼‰

### é›†æˆæµ‹è¯•

- âœ… å®Œæ•´æµç¨‹ï¼ˆé¦–æ¬¡ â†’ ç¿»è¯‘ â†’ äºŒæ¬¡ï¼‰
- âœ… ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­
- âœ… å¹¶å‘è¯·æ±‚
- âœ… é‡è¯•æœºåˆ¶

### E2E æµ‹è¯•

- âœ… Loon è„šæœ¬æ‹¦æˆª
- âœ… YouTube App å­—å¹•æ˜¾ç¤º
- âœ… å¤šè¯­è¨€ç»„åˆï¼ˆè‹±â†’ä¸­ã€æ—¥â†’ä¸­ã€éŸ©â†’ä¸­ï¼‰
- âœ… é•¿è§†é¢‘ï¼ˆ10+ åˆ†é’Ÿï¼‰

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ |
|------|--------|----------|
| é¦–æ¬¡å“åº”æ—¶é—´ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ | < 2s | æœåŠ¡ç«¯æ—¥å¿— |
| äºŒæ¬¡å“åº”æ—¶é—´ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ | < 200ms | æœåŠ¡ç«¯æ—¥å¿— |
| ç¿»è¯‘å®Œæˆæ—¶é—´ | < 60s | å¼‚æ­¥ä»»åŠ¡ç›‘æ§ |
| ç¼“å­˜å‘½ä¸­ç‡ | > 80% | SQLite ç»Ÿè®¡ |
| OpenAI API æˆåŠŸç‡ | > 95% | é”™è¯¯æ—¥å¿— |
| ä»»åŠ¡å¤±è´¥ç‡ | < 5% | å¤±è´¥ä»»åŠ¡ç»Ÿè®¡ |

### æ—¥å¿—ç¤ºä¾‹

```typescript
logger.info('Subtitle request', {
  videoId,
  lang,
  cacheStatus: 'MISS',
  responseTime: 1850
});

logger.info('Translation completed', {
  videoId,
  segmentCount: 45,
  duration: 48500,
  cost: 0.12  // USD
});
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯

```typescript
function validateRequest(params: any) {
  if (!params.v || !/^[a-zA-Z0-9_-]{11}$/.test(params.v)) {
    throw new Error('Invalid video ID');
  }

  if (!params.lang || params.lang.length > 10) {
    throw new Error('Invalid language code');
  }

  // é˜²æ­¢ URL æ³¨å…¥
  if (params.original_url) {
    const url = new URL(params.original_url);
    if (!url.hostname.includes('googlevideo.com')) {
      throw new Error('Invalid original URL');
    }
  }
}
```

### 2. é€Ÿç‡é™åˆ¶

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 åˆ†é’Ÿ
  max: 100,  // æœ€å¤š 100 ä¸ªè¯·æ±‚
  message: 'Too many requests, please try again later'
});

app.use('/api/subtitle', limiter);
```

### 3. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

- âŒ ä¸åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´å­—å¹•å†…å®¹
- âŒ ä¸åœ¨å“åº”å¤´ä¸­æš´éœ² API key
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿé…ç½®
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

---

## ğŸ“… å®æ–½é˜¶æ®µ

### é˜¶æ®µ 1ï¼šåŸºç¡€æ¶æ„ï¼ˆ2-3 å¤©ï¼‰

**ç›®æ ‡**ï¼šæ­å»ºæ ¸å¿ƒæœåŠ¡ï¼ŒéªŒè¯æŠ€æœ¯å¯è¡Œæ€§

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆå§‹åŒ–é¡¹ç›®ï¼ˆTypeScript + Honoï¼‰
- [ ] è®¾è®¡æ•°æ®åº“ Schemaï¼ˆSQLiteï¼‰
- [ ] å®ç° YouTube å­—å¹•è·å–
- [ ] å®ç° OpenAI ç¿»è¯‘è°ƒç”¨
- [ ] å®ç°ç¼“å­˜å±‚ï¼ˆLRU + SQLiteï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**äº¤ä»˜ç‰©**ï¼š
- å¯è¿è¡Œçš„ HTTP æœåŠ¡
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

---

### é˜¶æ®µ 2ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ3-4 å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„ç¿»è¯‘æµç¨‹

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°æ®µè½åˆ‡åˆ†ç®—æ³•
- [ ] å®ç° WebVTT æ¸²æŸ“
- [ ] å®ç°è¿›ç¨‹å†…ä»»åŠ¡é˜Ÿåˆ—
- [ ] å®ç°å¼‚æ­¥ç¿»è¯‘é€»è¾‘
- [ ] å®ç°é”™è¯¯å¤„ç†ä¸é‡è¯•
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´çš„ç¿»è¯‘æµç¨‹
- é›†æˆæµ‹è¯•é€šè¿‡

---

### é˜¶æ®µ 3ï¼šå‰ç«¯é›†æˆï¼ˆ1-2 å¤©ï¼‰

**ç›®æ ‡**ï¼šLoon/åœˆX è„šæœ¬é…ç½®

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ç¼–å†™ Loon è„šæœ¬
- [ ] ç¼–å†™åœˆX è„šæœ¬
- [ ] ç¼–å†™ç”¨æˆ·é…ç½®æ–‡æ¡£
- [ ] æµ‹è¯• iOS çœŸæœºç¯å¢ƒ

**äº¤ä»˜ç‰©**ï¼š
- å¯ç”¨çš„ Loon/åœˆX è„šæœ¬
- ç”¨æˆ·é…ç½®æŒ‡å—

---

### é˜¶æ®µ 4ï¼šéƒ¨ç½²ä¸ä¼˜åŒ–ï¼ˆ1-2 å¤©ï¼‰

**ç›®æ ‡**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ç¼–å†™ Dockerfile
- [ ] é…ç½® Nginx åå‘ä»£ç†
- [ ] é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] ç›‘æ§æ—¥å¿—é…ç½®

**äº¤ä»˜ç‰©**ï¼š
- Docker é•œåƒ
- éƒ¨ç½²æ–‡æ¡£
- ç›‘æ§ä»ªè¡¨ç›˜

---

### é˜¶æ®µ 5ï¼šæµ‹è¯•ä¸è¿­ä»£ï¼ˆ1-2 å¤©ï¼‰

**ç›®æ ‡**ï¼šéªŒè¯ç”¨æˆ·ä½“éªŒ

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] E2E æµ‹è¯•ï¼ˆçœŸå® YouTube è§†é¢‘ï¼‰
- [ ] å¤šè¯­è¨€ç»„åˆæµ‹è¯•
- [ ] é•¿è§†é¢‘æµ‹è¯•ï¼ˆ10+ åˆ†é’Ÿï¼‰
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ

**äº¤ä»˜ç‰©**ï¼š
- æµ‹è¯•æŠ¥å‘Š
- Bug ä¿®å¤
- ç”¨æˆ·åé¦ˆæ–‡æ¡£

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

### æŠ€æœ¯æ–‡æ¡£

- **åç«¯æ¶æ„è®¾è®¡**ï¼š`docs/backend-architecture.md`ï¼ˆCodex è¾“å‡ºï¼‰
- **å‰ç«¯é…ç½®æŒ‡å—**ï¼š`docs/frontend-config.md`ï¼ˆClaude è¾“å‡ºï¼‰
- **API æ¥å£æ–‡æ¡£**ï¼š`docs/api-reference.md`
- **æ•°æ®åº“è®¾è®¡**ï¼š`docs/database-schema.md`

### å¤–éƒ¨èµ„æº

- **Hono æ¡†æ¶**ï¼šhttps://hono.dev/
- **OpenAI API**ï¼šhttps://platform.openai.com/docs/
- **WebVTT è§„èŒƒ**ï¼šhttps://w3c.github.io/webvtt/
- **Loon æ–‡æ¡£**ï¼šhttps://nsloon.app/docs/
- **Quantumult X æ–‡æ¡£**ï¼šhttps://quantumult.app/x/

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### MVP éªŒæ”¶æ ‡å‡†

âœ… **åŠŸèƒ½å®Œæ•´æ€§**ï¼š
- é¦–æ¬¡è¯·æ±‚è¿”å›åŸå­—å¹•ï¼ˆ< 2sï¼‰
- äºŒæ¬¡è¯·æ±‚è¿”å›åŒè¯­å­—å¹•
- ç¼“å­˜å‘½ä¸­ç‡ > 80%

âœ… **ç¿»è¯‘è´¨é‡**ï¼š
- GPT-4o ç¿»è¯‘è‡ªç„¶æµç•…
- åŒè¯­å¯¹é½æ­£ç¡®
- ç‰¹æ®Šå­—ç¬¦æ­£ç¡®è½¬ä¹‰

âœ… **ç”¨æˆ·ä½“éªŒ**ï¼š
- iOS YouTube App æ­£å¸¸æ˜¾ç¤ºå­—å¹•
- Loon/åœˆX è„šæœ¬é…ç½®ç®€å•ï¼ˆ< 5 åˆ†é’Ÿï¼‰
- é”™è¯¯æç¤ºæ¸…æ™°

âœ… **æ€§èƒ½æŒ‡æ ‡**ï¼š
- é¦–æ¬¡å“åº” < 2s
- ç¼“å­˜å‘½ä¸­ < 200ms
- ç¿»è¯‘å®Œæˆ < 60s

âœ… **ç¨³å®šæ€§**ï¼š
- 24 å°æ—¶è¿è¡Œæ— å´©æºƒ
- é”™è¯¯æ¢å¤æœºåˆ¶æœ‰æ•ˆ
- ä»»åŠ¡é‡è¯•æˆåŠŸç‡ > 90%

---

## ğŸš§ å·²çŸ¥é™åˆ¶

### å½“å‰ç‰ˆæœ¬ï¼ˆMVPï¼‰

1. **å•æœºéƒ¨ç½²**ï¼šä¸æ”¯æŒå¤šå®ä¾‹è´Ÿè½½å‡è¡¡
2. **è¿›ç¨‹å†…é˜Ÿåˆ—**ï¼šè¿›ç¨‹é‡å¯ä»»åŠ¡ä¸¢å¤±
3. **æ— ç›‘æ§é¢æ¿**ï¼šä¾èµ–æ—¥å¿—æ–‡ä»¶
4. **æ— ç”¨æˆ·è®¤è¯**ï¼šAPI å…¬å¼€è®¿é—®

### æœªæ¥ä¼˜åŒ–æ–¹å‘

- åˆ†å¸ƒå¼æ¶æ„ï¼ˆæ–¹æ¡ˆ Bï¼‰
- ç‹¬ç«‹æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis + BullMQï¼‰
- å®æ—¶ç¿»è¯‘è¿›åº¦æ¨é€ï¼ˆWebSocketï¼‰
- ç”¨æˆ·ç®¡ç†åå°ï¼ˆé…é¢ã€API keyï¼‰
- å¤šæ¨¡å‹æ”¯æŒï¼ˆClaudeã€Gemini å¤‡é€‰ï¼‰
- æ‰¹é‡é¢„çƒ­ï¼ˆçƒ­é—¨è§†é¢‘æå‰ç¿»è¯‘ï¼‰

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

- **GitHub Issues**ï¼šhttps://github.com/your-repo/issues
- **æ–‡æ¡£ç«™ç‚¹**ï¼šhttps://your-domain.com/docs
- **é‚®ç®±**ï¼šsupport@your-domain.com

---

**æœ€åæ›´æ–°**ï¼š2026-01-29
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0
**æ‰¹å‡†çŠ¶æ€**ï¼šå¾…ç”¨æˆ·æ‰¹å‡†
